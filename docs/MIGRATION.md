# Migration Guide: Objective-C to Swift

This guide helps users and developers understand the differences between the Objective-C and Swift implementations of pdf22png.

## For Users

### Command-Line Interface
Both implementations share the **exact same** command-line interface. All flags, options, and behaviors are identical:

```bash
# These commands work identically in both versions
pdf22png input.pdf output.png
pdf22png -r 300 -t input.pdf output.png
pdf22png -a -d output_dir document.pdf
```

### Output Compatibility
- PNG files generated by both versions are functionally identical
- Both versions produce the same image quality and dimensions
- File naming conventions are preserved

### Performance Considerations
- **Swift version**: Generally faster for batch operations due to Swift Concurrency
- **Objective-C version**: Mature implementation with proven stability
- Both versions use the same Core Graphics rendering engine

### Choosing a Version

Use the **Swift version** (default) if you:
- Want the latest performance optimizations
- Are running on newer macOS versions (10.15+)
- Prefer modern Swift error messages

Use the **Objective-C version** if you:
- Need compatibility with older build systems
- Have existing scripts that depend on specific error message formats
- Require the most battle-tested implementation

## For Developers

### Building from Source

#### Swift Version
```bash
# Requires Swift 5.7+ and swift-argument-parser
make swift
# or simply
make
```

#### Objective-C Version
```bash
# Requires Xcode Command Line Tools
make objc
```

### Code Structure Comparison

#### Objective-C Structure
```
src/
├── pdf22png.m      # Main program and CLI parsing
├── utils.m         # Utility functions
├── pdf22png.h      # Main header
├── utils.h         # Utility header
└── errors.h        # Error definitions
```

#### Swift Structure
```
Sources/pdf22png/
├── main.swift      # Entry point and CLI
├── Models.swift    # Data structures
└── Utilities.swift # Helper functions
```

### Key Implementation Differences

#### 1. Command-Line Parsing
- **Objective-C**: Uses `getopt_long` for parsing
- **Swift**: Uses `swift-argument-parser` framework

#### 2. Error Handling
- **Objective-C**: Integer error codes with C-style error reporting
- **Swift**: Typed errors with Swift's native error handling

#### 3. Concurrency
- **Objective-C**: Grand Central Dispatch (GCD) with dispatch queues
- **Swift**: Swift Concurrency with async/await and TaskGroup

#### 4. Memory Management
- **Objective-C**: Manual `@autoreleasepool` blocks
- **Swift**: Automatic memory management with ARC

### API Differences

#### Scale Specification Parsing

Objective-C:
```objc
ScaleSpec scale;
BOOL success = parseScaleSpec("150%", &scale);
```

Swift:
```swift
let scale = parseScaleSpecification("150%")
// Returns optional ScaleSpecification
```

#### PDF Rendering

Objective-C:
```objc
CGImageRef image = renderPDFPageToImage(pdfPage, scaleFactor, 
                                       transparentBackground, verbose);
```

Swift:
```swift
let image = renderPDFPageToImage(page: pdfPage, 
                                scaleFactor: scaleFactor,
                                transparentBackground: transparent,
                                verbose: verbose)
```

### Testing

#### Objective-C Tests
```bash
make test-objc
# Uses custom test runner
```

#### Swift Tests
```bash
make swift-test
# Uses XCTest framework
```

### Extending the Code

#### Adding New Options

In Objective-C:
1. Add to `long_options` array in `pdf22png.m`
2. Update `Options` struct in `pdf22png.h`
3. Add parsing logic in `parseArguments`

In Swift:
1. Add `@Option` or `@Flag` property to `PDF22PNG` struct
2. Update `ProcessingOptions` in `Models.swift`
3. ArgumentParser handles parsing automatically

#### Adding New Features

Both versions follow similar patterns:
1. Update the data models
2. Implement the feature logic
3. Add command-line support
4. Write tests
5. Update documentation

### Migration Checklist

If migrating custom modifications from Objective-C to Swift:

- [ ] Port custom command-line options
- [ ] Convert error codes to Swift errors
- [ ] Update GCD code to Swift Concurrency
- [ ] Adapt C-style callbacks to Swift closures
- [ ] Replace manual memory management with Swift patterns
- [ ] Update tests to XCTest format
- [ ] Verify output compatibility

### Common Gotchas

1. **String Handling**: Swift strings are Unicode-correct by default
2. **Optionals**: Swift requires explicit nil handling
3. **Error Propagation**: Swift uses `throws` instead of error pointers
4. **Type Safety**: Swift is more strict about type conversions
5. **Interop**: Some Core Graphics APIs have different Swift signatures